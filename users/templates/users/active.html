{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} - Clinic Management System{% endblock %}

{% block header %}{{ title }}{% endblock %}

{% block content %}
<div class="space-y-6">
  <!-- Page Header with Stats -->
  <div class="bg-gradient-to-r from-green-600 to-green-700 rounded-lg p-6 text-white">
    <div class="flex items-center justify-between">
      <div>
        <h2 class="text-2xl font-bold mb-2">{{ title }}</h2>
        <p class="text-green-100">Currently active prescriptions for your patients</p>
      </div>
      <div class="text-right">
        <div class="text-3xl font-bold">{{ total_prescriptions }}</div>
        <div class="text-green-100">Active Prescriptions</div>
      </div>
    </div>
  </div>

  <!-- Filter and Search Controls -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <div class="flex flex-col lg:flex-row gap-4 items-center justify-between">
      <div class="flex flex-col sm:flex-row gap-4 flex-1">
        <div class="relative max-w-md">
          <input
            type="text"
            id="searchPrescription"
            placeholder="Search by patient name or medication..."
            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
          >
          <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
        </div>
        <select id="dateFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
          <option value="all">All Active</option>
          <option value="today">Issued Today</option>
          <option value="week">This Week</option>
          <option value="month">This Month</option>
        </select>
      </div>
      <div class="flex gap-2">
        <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
          <i class="fa-solid fa-plus mr-2"></i>New Prescription
        </button>
        <button class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
          <i class="fa-solid fa-download mr-2"></i>Export
        </button>
      </div>
    </div>
  </div>

  <!-- Active Prescriptions List -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200">
    <div class="px-6 py-4 border-b border-gray-200">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-800">Active Prescriptions</h3>
        <div class="flex items-center space-x-4 text-sm text-gray-500">
          <span>Total: {{ total_prescriptions }} prescriptions</span>
        </div>
      </div>
    </div>

    {% if prescriptions %}
      <div class="divide-y divide-gray-200">
        {% for prescription in prescriptions %}
          <div class="p-6 hover:bg-gray-50 transition-colors prescription-record" 
               data-patient-name="{{ prescription.patient.get_full_name|lower }}"
               data-medication="{{ prescription.medication_name|lower }}"
               data-date="{{ prescription.date_issued|date:'Y-m-d' }}">
            
            <div class="flex items-start justify-between">
              <!-- Patient and Prescription Info -->
              <div class="flex-1">
                <div class="flex items-center mb-4">
                  <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mr-4">
                    <i class="fa-solid fa-prescription text-green-600 text-lg"></i>
                  </div>
                  <div class="flex-1">
                    <div class="flex items-center justify-between">
                      <h4 class="font-semibold text-gray-900 text-lg">{{ prescription.patient.get_full_name }}</h4>
                      <div class="flex items-center space-x-2">
                        <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">
                          <i class="fa-solid fa-circle text-xs mr-1"></i>Active
                        </span>
                        {% if prescription.is_urgent %}
                          <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-medium">
                            <i class="fa-solid fa-exclamation-triangle text-xs mr-1"></i>Urgent
                          </span>
                        {% endif %}
                      </div>
                    </div>
                    <div class="flex items-center text-sm text-gray-500 space-x-4 mt-1">
                      <span>
                        <i class="fa-solid fa-calendar mr-1"></i>
                        Issued: {{ prescription.date_issued|date:'M d, Y' }}
                      </span>
                      {% if prescription.appointment %}
                        <span>
                          <i class="fa-solid fa-stethoscope mr-1"></i>
                          Visit: {{ prescription.appointment.appointment_datetime|date:'M d, Y' }}
                        </span>
                      {% endif %}
                    </div>
                  </div>
                </div>

                <!-- Medication Details -->
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                      <div class="text-sm font-medium text-gray-700 mb-1">Medication</div>
                      <div class="text-gray-900 font-semibold">{{ prescription.medication_name }}</div>
                    </div>
                    <div>
                      <div class="text-sm font-medium text-gray-700 mb-1">Dosage</div>
                      <div class="text-gray-900">{{ prescription.dosage|default:'Not specified' }}</div>
                    </div>
                    <div>
                      <div class="text-sm font-medium text-gray-700 mb-1">Frequency</div>
                      <div class="text-gray-900">{{ prescription.frequency|default:'As needed' }}</div>
                    </div>
                    <div>
                      <div class="text-sm font-medium text-gray-700 mb-1">Duration</div>
                      <div class="text-gray-900">{{ prescription.duration|default:'Ongoing' }}</div>
                    </div>
                    <div>
                      <div class="text-sm font-medium text-gray-700 mb-1">Quantity</div>
                      <div class="text-gray-900">{{ prescription.quantity|default:'N/A' }}</div>
                    </div>
                    <div>
                      <div class="text-sm font-medium text-gray-700 mb-1">Refills</div>
                      <div class="text-gray-900">{{ prescription.refills_remaining|default:'0' }} remaining</div>
                    </div>
                  </div>
                </div>

                <!-- Instructions and Notes -->
                {% if prescription.instructions %}
                  <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center mb-2">
                      <i class="fa-solid fa-info-circle text-blue-600 mr-2"></i>
                      <span class="font-medium text-blue-900">Instructions</span>
                    </div>
                    <div class="text-blue-800 text-sm leading-relaxed">
                      {{ prescription.instructions|linebreaks }}
                    </div>
                  </div>
                {% endif %}

                {% if prescription.notes %}
                  <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center mb-2">
                      <i class="fa-solid fa-sticky-note text-yellow-600 mr-2"></i>
                      <span class="font-medium text-yellow-900">Notes</span>
                    </div>
                    <div class="text-yellow-800 text-sm leading-relaxed">
                      {{ prescription.notes|linebreaks }}
                    </div>
                  </div>
                {% endif %}

                <!-- Patient Contact Info -->
                <div class="flex items-center space-x-6 text-sm text-gray-600">
                  <div class="flex items-center">
                    <i class="fa-solid fa-phone w-4 h-4 mr-2 text-gray-400"></i>
                    <span>{{ prescription.patient.phone|default:'Not provided' }}</span>
                  </div>
                  <div class="flex items-center">
                    <i class="fa-solid fa-envelope w-4 h-4 mr-2 text-gray-400"></i>
                    <span>{{ prescription.patient.email|default:'Not provided' }}</span>
                  </div>
                  {% if prescription.patient.date_of_birth %}
                    <div class="flex items-center">
                      <i class="fa-solid fa-birthday-cake w-4 h-4 mr-2 text-gray-400"></i>
                      <span>Age: {% now "Y" as current_year %}{{ current_year|add:"-"|add:prescription.patient.date_of_birth.year }}</span>
                    </div>
                  {% endif %}
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="ml-6 flex flex-col space-y-2 min-w-max">
                <button class="px-4 py-2 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors">
                  <i class="fa-solid fa-edit mr-1"></i>Edit
                </button>
                <button class="px-4 py-2 text-sm bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-colors">
                  <i class="fa-solid fa-print mr-1"></i>Print
                </button>
                <button class="px-4 py-2 text-sm bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors">
                  <i class="fa-solid fa-redo mr-1"></i>Refill
                </button>
                <button class="px-4 py-2 text-sm bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors">
                  <i class="fa-solid fa-stop mr-1"></i>Deactivate
                </button>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Pagination -->
      {% if prescriptions.has_other_pages %}
        <div class="px-6 py-4 border-t border-gray-200 bg-gray-50">
          <div class="flex items-center justify-between">
            <div class="text-sm text-gray-600">
              Showing {{ prescriptions.start_index }} to {{ prescriptions.end_index }} of {{ prescriptions.paginator.count }} prescriptions
            </div>
            <div class="flex space-x-1">
              {% if prescriptions.has_previous %}
                <a href="?page={{ prescriptions.previous_page_number }}" 
                   class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-100 transition-colors">
                  <i class="fa-solid fa-chevron-left mr-1"></i>Previous
                </a>
              {% endif %}

              {% for num in prescriptions.paginator.page_range %}
                {% if prescriptions.number == num %}
                  <span class="px-3 py-1 text-sm bg-green-600 text-white rounded">{{ num }}</span>
                {% elif num > prescriptions.number|add:'-3' and num < prescriptions.number|add:'3' %}
                  <a href="?page={{ num }}" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-100 transition-colors">{{ num }}</a>
                {% endif %}
              {% endfor %}

              {% if prescriptions.has_next %}
                <a href="?page={{ prescriptions.next_page_number }}" 
                   class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-100 transition-colors">
                  Next<i class="fa-solid fa-chevron-right ml-1"></i>
                </a>
              {% endif %}
            </div>
          </div>
        </div>
      {% endif %}

    {% else %}
      <!-- Empty State -->
      <div class="p-12 text-center">
        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fa-solid fa-prescription text-2xl text-gray-400"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No Active Prescriptions</h3>
        <p class="text-gray-500 mb-6">You don't have any active prescriptions at the moment.</p>
        <a href="{% url 'prescriptions:list_prescriptions' %}" 
           class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
          <i class="fa-solid fa-prescription mr-2"></i>
          View All Prescriptions
        </a>
      </div>
    {% endif %}
  </div>

  <!-- Quick Action Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <div class="flex items-center">
        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-4">
          <i class="fa-solid fa-prescription text-xl text-green-600"></i>
        </div>
        <div>
          <div class="text-2xl font-bold text-gray-900">{{ total_prescriptions }}</div>
          <div class="text-sm text-gray-500">Active Total</div>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <div class="flex items-center">
        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
          <i class="fa-solid fa-clock text-xl text-blue-600"></i>
        </div>
        <div>
          <div class="text-2xl font-bold text-gray-900">
            {% if prescriptions %}{{ prescriptions|length }}{% else %}0{% endif %}
          </div>
          <div class="text-sm text-gray-500">This Page</div>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <div class="flex items-center">
        <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center mr-4">
          <i class="fa-solid fa-exclamation-triangle text-xl text-yellow-600"></i>
        </div>
        <div>
          <div class="text-2xl font-bold text-gray-900">
            {% with urgent_count=0 %}
              {% for prescription in prescriptions %}
                {% if prescription.is_urgent %}
                  {% with urgent_count=urgent_count|add:1 %}{% endwith %}
                {% endif %}
              {% endfor %}
              {{ urgent_count }}
            {% endwith %}
          </div>
          <div class="text-sm text-gray-500">Urgent</div>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <div class="flex items-center">
        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-4">
          <i class="fa-solid fa-redo text-xl text-purple-600"></i>
        </div>
        <div>
          <div class="text-2xl font-bold text-gray-900">
            {% with refill_count=0 %}
              {% for prescription in prescriptions %}
                {% if prescription.refills_remaining > 0 %}
                  {% with refill_count=refill_count|add:1 %}{% endwith %}
                {% endif %}
              {% endfor %}
              {{ refill_count }}
            {% endwith %}
          </div>
          <div class="text-sm text-gray-500">With Refills</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Search functionality
  document.getElementById('searchPrescription').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const records = document.querySelectorAll('.prescription-record');
    
    records.forEach(record => {
      const patientName = record.getAttribute('data-patient-name');
      const medication = record.getAttribute('data-medication');
      if (patientName.includes(searchTerm) || medication.includes(searchTerm)) {
        record.style.display = '';
      } else {
        record.style.display = 'none';
      }
    });
  });

  // Date filter functionality
  document.getElementById('dateFilter').addEventListener('change', function(e) {
    const filterValue = e.target.value;
    const records = document.querySelectorAll('.prescription-record');
    const today = new Date();
    
    records.forEach(record => {
      const recordDate = new Date(record.getAttribute('data-date'));
      let showRecord = true;
      
      switch(filterValue) {
        case 'today':
          showRecord = recordDate.toDateString() === today.toDateString();
          break;
        case 'week':
          const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
          showRecord = recordDate >= weekAgo;
          break;
        case 'month':
          showRecord = recordDate.getMonth() === today.getMonth() && recordDate.getFullYear() === today.getFullYear();
          break;
        default:
          showRecord = true;
      }
      
      record.style.display = showRecord ? '' : 'none';
    });
  });
</script>
{% endblock %}